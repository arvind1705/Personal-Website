<!DOCTYPE html><html>
<!-- Mirrored from christopher.su/2015/text-announcements/ by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 02 Aug 2017 17:06:01 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"><title>Setting up a Text Message Announcement System - Christopher Su</title><script src="../../cdn-cgi/apps/head/Md70coOFj-W1ipSNpRLrMg41doI.js"></script><link rel="stylesheet" href="../../public/css/custom.css"><link href="https://fonts.googleapis.com/css?family=Open+Sans:700,400|Droid+Serif:400,700,400italic" rel="stylesheet" type="text/css"><link rel="shortcut icon" href="../../public/favicon.ico"><link rel="alternate" type="application/rss+xml" title="RSS" href="../../atom.xml"></head><body><div class="container content"><div class="masthead"><h3 class="masthead-title"><a href="../../index.html" title="Home">Christopher Su</a> <span class="top-nav nav-bar"><span class="top-nav-item"><a href="../../about/index.html" title="About">About</a></span> <span class="top-nav-item"><a href="../../projects/index.html" title="Projects">Projects</a></span> <span class="top-nav-item"><a href="../../contact/index.html" " title="Contact">Contact</a></span> <span class="top-nav-item"><a href="../../index/index.html" title="More">More</a></span></span></h3></div> <nav id="breadcrumb-nav" class="nav-bar"><span class="csu-breadcrumb"><a href="../../index.html">Home</a></span><ol class="csu-breadcrumbs" vocab="http://schema.org/" typeof="BreadcrumbList"><li class="csu-breadcrumb" property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" href="../../blog/index.html"><span property="name">Blog</span></a><meta property="position" content="1"></li> <li class="csu-breadcrumb active" property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" href="index.html"><span property="name">Setting up a Text Message Announcement System</span></a><meta property="position" content="2"></li></ol></nav> <div class="post"><div class="post-header"><h1 class="post-title">Setting up a Text Message Announcement System</h1><span class="post-date">October 22, 2015</span></div><div class="post-content"><p>At this year’s <a href="http://15f.dubhacks.co/" rel="nofollow">DubHacks</a>, we used a text announcement system to send important information to over 700+ attendees, mentors, and sponsors throughout the hackathon. As attendees were working in separate classrooms spread across multiple buildings, the mass-SMS system was particularly effective in notifying everyone of upcoming events. This post explains how to quickly setup and use Batch SMS, the open source project I developed to send large amounts of text announcements.</p>

<h2 id="sections">Sections</h2>
<ol>
  <li><a href="#overview">Design Overview</a></li>
  <li><a href="#installation">Installation</a></li>
  <li><a href="#basic-usage">Basic Usage</a></li>
  <li><a href="#normalizing-numbers">Normalizing Numbers</a></li>
  <li><a href="#unsubscribing">Unsubscribing</a></li>
  <li><a href="#incoming-messages">Incoming Messages</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ol>

<h2 id="design-overview"><a name="overview"></a>Design Overview</h2>
<p>The code for Batch SMS can be found on GitHub at <a href="https://github.com/csu/batch_sms">csu/batch_sms</a>. It is written in Python and uses the <a href="http://twilio.com/" rel="nofollow">Twilio</a> API for sending text messages (but it is written in a way such that Twilio could easily be swapped out for an equivalent service).</p>

<p>Twilio <em>rate limits message sending to one text per second</em> per phone number, so the system is also capable of load balancing a text across multiple “from” numbers (the numbers you own, from which the texts are being sent).</p>

<p>While we do want to distribute the texts across multiple “from” numbers, we still want each receiving number to always receive texts from the same sending number. Thus, the system maintains associations between “from” numbers and “to” numbers and persists them in a database. Any database supported by <a href="http://www.sqlalchemy.org/">SQLAlchemy</a> can be used with the system (this includes SQLite, MySQL, PostgreSQL, and MariaDB).</p>

<h2 id="installation"><a name="installation"></a>Installation</h2>
<p>First, install all necessary requirements:</p>

<ul>
  <li>Python 2</li>
  <li>pip (for installing Python dependencies)</li>
  <li>A SQLAlchemy-compatible database (SQLite is sufficient)</li>
</ul>

<p>Now, get the code by cloning the git repository:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/csu/batch_sms.git
<span class="nb">cd </span>batch_sms
</code></pre>
</div>

<p>Install the necessary Python dependencies (optionally, enter a Python virtual environment before doing this):</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>pip install -r requirements.txt
</code></pre>
</div>

<p>Now you’re good to go!</p>

<h2 id="basic-usage"><a name="basic-usage"></a>Basic Usage</h2>
<p>Create a new Python script or enter the interactive Python REPL. Now enter the following:</p>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">batch_sms</span> <span class="kn">import</span> <span class="n">BatchSMS</span>
<span class="kn">from</span> <span class="nn">batch_sms</span> <span class="kn">import</span> <span class="n">AssociatedBatchSender</span>
<span class="kn">from</span> <span class="nn">batch_sms</span> <span class="kn">import</span> <span class="n">TwilioSender</span>
<span class="kn">from</span> <span class="nn">secrets</span> <span class="kn">import</span> <span class="n">TWILIO_ACCOUNT_SID</span><span class="p">,</span> <span class="n">TWILIO_AUTH_TOKEN</span>

<span class="n">sender</span> <span class="o">=</span> <span class="n">TwilioSender</span><span class="p">(</span><span class="n">TWILIO_ACCOUNT_SID</span><span class="p">,</span> <span class="n">TWILIO_AUTH_TOKEN</span><span class="p">)</span>
<span class="n">batch_sender</span> <span class="o">=</span> <span class="n">AssociatedBatchSender</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">BatchSMS</span><span class="p">(</span><span class="s">'test.db'</span><span class="p">,</span> <span class="n">batch_sender</span><span class="p">,</span> <span class="n">auto_associate</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre>
</div>

<p>Here’s what this does:</p>

<ul>
  <li>The first few lines <code class="highlighter-rouge">import</code> what we need from the Batch SMS module.</li>
  <li>We then create a <code class="highlighter-rouge">TwilioSender</code>, which knows how to send messages using Twilio.</li>
  <li>We then create an <code class="highlighter-rouge">AssociatedBatchSender</code>, which knows how to send large numbers of messages while obeying to-from number relationships (we pass it the <code class="highlighter-rouge">TwilioSender</code>, which it will use for the actual message sending).</li>
  <li>The components are separated in this way so you could swap out the <code class="highlighter-rouge">TwilioSender</code> for another object that implements the same interface (e.g. if you wanted to use another API besides Twilio to do the actual SMS sending).</li>
  <li>Finally, we create a <code class="highlighter-rouge">BatchSMS</code> object which will manage data persistence.</li>
  <li>The <code class="highlighter-rouge">auto_associate</code> option will automatically associate newly added “to” numbers with “from” numbers. It attempts to distribute “to” numbers as evenly as possible across “from” numbers.</li>
</ul>

<p>Now, we can create a “subscription list” which consists of a list of recipients. Give it a name, like <code class="highlighter-rouge">Hackers</code>:</p>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="n">sub_id</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_subscription_list</span><span class="p">(</span><span class="s">'Hackers'</span><span class="p">)</span>
</code></pre>
</div>

<p>Add your “from” numbers from which you will send messages:</p>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="n">client</span><span class="o">.</span><span class="n">add_from_number</span><span class="p">(</span><span class="s">'+15005550006'</span><span class="p">)</span>
</code></pre>
</div>

<p>Now add your “to” numbers and include them in the subscription list you just created:</p>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="n">client</span><span class="o">.</span><span class="n">add_to_number</span><span class="p">(</span><span class="s">'+15005550010'</span><span class="p">,</span> <span class="n">subs</span><span class="o">=</span><span class="p">[</span><span class="n">sub_id</span><span class="p">])</span>
<span class="n">client</span><span class="o">.</span><span class="n">add_to_number</span><span class="p">(</span><span class="s">'+15005550011'</span><span class="p">,</span> <span class="n">subs</span><span class="o">=</span><span class="p">[</span><span class="n">sub_id</span><span class="p">])</span>
<span class="n">client</span><span class="o">.</span><span class="n">add_to_number</span><span class="p">(</span><span class="s">'+15005550012'</span><span class="p">,</span> <span class="n">subs</span><span class="o">=</span><span class="p">[</span><span class="n">sub_id</span><span class="p">])</span>
<span class="n">client</span><span class="o">.</span><span class="n">add_to_number</span><span class="p">(</span><span class="s">'+15005550013'</span><span class="p">,</span> <span class="n">subs</span><span class="o">=</span><span class="p">[</span><span class="n">sub_id</span><span class="p">])</span>
</code></pre>
</div>

<p>We can now send a message to all recipients in the “Hackers” subscription list like so:</p>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="n">client</span><span class="o">.</span><span class="n">send_to_subscription</span><span class="p">(</span><span class="n">sub_id</span><span class="p">,</span> <span class="s">'Hello World'</span><span class="p">)</span>
</code></pre>
</div>

<p>If you want some feedback printed to <code class="highlighter-rouge">stdout</code> (or want to do anything after the messages are sent), you can pass in a callback:</p>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">payload</span>

<span class="n">client</span><span class="o">.</span><span class="n">send_to_subscription</span><span class="p">(</span><span class="n">sub_id</span><span class="p">,</span> <span class="s">'Hello World'</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
</code></pre>
</div>

<h2 id="normalizing-numbers"><a name="normalizing-numbers"></a>Normalizing Numbers</h2>
<p>Depending on how you’re collecting phone numbers from recipients, you may end up with phone numbers in all different formats or numbers that are entirely invalid. I wrote <a href="https://github.com/csu/batch_sms/blob/master/scripts/normalize_numbers.py">a simple Python script</a> that normalizes numbers from a <code class="highlighter-rouge">csv</code> file into the <code class="highlighter-rouge">+1XXXYYYZZZZ</code> format that Twilio likes while discarding invalid phone numbers (e.g. ones of improper length).</p>

<h2 id="unsubscribing"><a name="unsubscribing"></a>Unsubscribing</h2>
<p>Conveniently, Twilio already handles unsubscribing/opt-out and resubscribing for us. Users can text STOP, UNSUBSCRIBE, and other commands to opt-out of notifications. Users can text START and YES to resubscribe. For the full list of commands included by Twilio, see <a href="https://www.twilio.com/help/faq/sms/does-twilio-support-stop-block-and-cancel-aka-sms-filtering">their article on the topic</a>.</p>

<h2 id="incoming-messages"><a name="incoming-messages"></a>Incoming Messages</h2>
<p>By default, Twilio will not do anything with incoming messages and will reply to them with a message telling you to setup your incoming message handler. I quickly threw together <a href="https://github.com/csu/batch_sms/blob/master/scripts/incoming.php">this short PHP script</a> that will receive incoming messages, forward them to another number (e.g. my phone), and then reply to the sender of the message with a generic response (e.g. “email the DubHacks team with questions”).</p>

<h2 id="conclusion"><a name="conclusion"></a>Conclusion</h2>
<p>All in all, the system was very effective at DubHacks. It took around one minute to send out 700+ text messages load balanced across five sending numbers. The success rate for message sends was high and it felt great being able to hit enter on my keyboard and seeing hundreds of people appear at an activity or event shortly after.</p>

<p>I wrote this whole thing in one go. If you find any typos or errors, please <a href="../../contact/index.html">contact me</a>. Feel free to message me with any questions or concerns.</p>
</div></div><hr><div class="post-footer"><div id="comments"><h3>Comments</h3> <div id="disqus_thread"></div><script type="text/javascript">var disqus_shortname="christophersu";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script><div class="footer"><p class="copyright">&copy; 2012-2017 Christopher Su. All rights reserved.</p></div></div><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","../../../www.google-analytics.com/analytics.js","ga"),ga("create","UA-34248999-1","auto"),ga("send","pageview");</script> </body>
<!-- Mirrored from christopher.su/2015/text-announcements/ by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 02 Aug 2017 17:06:01 GMT -->
</html>